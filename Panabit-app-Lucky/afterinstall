#!/bin/sh

APPNAME="lucky"
RAMROOT="/usr/ramdisk/app/${APPNAME}"
APPROOT="/usr/panabit/app/${APPNAME}"

# 创建必要的目录
mkdir -p ${APPROOT}/bin 2>/dev/null || true

# 检测系统架构并复制对应的二进制文件
CPU_TYPE=`uname -m`

if [ "${CPU_TYPE}" = "aarch64" ]; then
    cp ${RAMROOT}/lib/arm/lucky ${APPROOT}/bin/lucky
else
    cp ${RAMROOT}/lib/linux/lucky ${APPROOT}/bin/lucky
fi

# 设置执行权限
chmod +x ${APPROOT}/bin/lucky

# 清理lib目录
rm -rf ${RAMROOT}/lib 2>/dev/null || true
rm -rf ${APPROOT}/lib 2>/dev/null || true

# 创建配置目录和文件
mkdir -p /etc/App/lucky 2>/dev/null || true
mkdir -p /etc/lucky 2>/dev/null || true

# 创建应用状态配置
echo "status=enable" > /etc/App/lucky/lucky 2>/dev/null || true

# 创建 lucky 配置文件（仅在不存在时创建，避免升级覆盖）
LUCKYCONF="/etc/lucky/lucky.conf"
if [ ! -f ${LUCKYCONF} ]; then
    cat > ${LUCKYCONF} << 'EOF'
{
  "Admin": {
    "Username": "666",
    "Password": "666",
    "Port": 16601,
    "WebPath": "/",
    "LogLevel": "info"
  },
  "ConfigVersion": "2.19.5"
}
EOF
fi

# 设置权限
chmod 644 /etc/lucky/lucky.conf
chmod +x ${APPROOT}/bin/lucky

# afterinstall不启动服务，由Panabit系统调用appctrl enable来启动
exit 0
